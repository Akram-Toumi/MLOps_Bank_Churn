// Jenkinsfile MLOps - Version finale fonctionnelle
pipeline {
    agent any
    
    environment {
        PYTHON = "C:\\Users\\Tech House\\AppData\\Local\\Programs\\Python\\Python312\\python.exe"
        PYTHONUTF8 = "1"
    }
    
    stages {
        stage('Setup') {
            steps {
                bat """
                    echo ========================================
                    echo SETUP
                    echo ========================================
                    
                    REM CrÃ©er les dossiers nÃ©cessaires
                    if not exist data mkdir data
                    if not exist data\\production mkdir data\\production
                    if not exist data\\batches mkdir data\\batches
                    if not exist data\\train mkdir data\\train
                    
                    REM Copier les batches depuis le projet local
                    copy "C:\\Users\\Tech House\\Desktop\\3eme\\mlops\\mlops\\MLOps_Bank_Churn\\data\\batches\\batch1.csv" "data\\batches\\batch1.csv" /Y
                    copy "C:\\Users\\Tech House\\Desktop\\3eme\\mlops\\mlops\\MLOps_Bank_Churn\\data\\batches\\batch2.csv" "data\\batches\\batch2.csv" /Y
                    copy "C:\\Users\\Tech House\\Desktop\\3eme\\mlops\\mlops\\MLOps_Bank_Churn\\data\\train\\part1.csv" "data\\train\\part1.csv" /Y
                    
                    echo Setup OK
                """
            }
        }
        
        stage('Install') {
            steps {
                bat """
                    echo ========================================
                    echo INSTALLATION
                    echo ========================================
                    "${PYTHON}" -m pip install --quiet evidently==0.4.33 pandas numpy
                    "${PYTHON}" -c "from evidently.report import Report; print('âœ“ Evidently OK')"
                """
            }
        }
        
        stage('Generate Data') {
            steps {
                bat """
                    echo ========================================
                    echo GENERATION DONNEES
                    echo ========================================
                    "${PYTHON}" scripts/generate_prod_data.py
                """
            }
        }
        
        stage('Monitor') {
            steps {
                bat """
                    echo ========================================
                    echo MONITORING
                    echo ========================================
                    "${PYTHON}" monitoring/run_monitoring.py
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'monitoring/*.html, monitoring/*.json', allowEmptyArchive: true
                }
            }
        }
        
        stage('Check Drift') {
            steps {
                script {
                    if (fileExists('trigger.txt')) {
                        echo 'ðŸš¨ DRIFT DETECTED'
                        env.DRIFT_DETECTED = 'true'
                    } else {
                        echo 'âœ“ No drift'
                        env.DRIFT_DETECTED = 'false'
                    }
                }
            }
        }
        
        stage('Retrain Model') {
            when {
                expression { env.DRIFT_DETECTED == 'true' }
            }
            steps {
                bat """
                    echo ========================================
                    echo RETRAINING MODEL
                    echo ========================================
                    "${PYTHON}" scripts/retrain_model.py
                """
            }
        }
        
        stage('Run Tests') {
            steps {
                bat """
                    echo ========================================
                    echo RUNNING TESTS
                    echo ========================================
                    "${PYTHON}" -m pip install --quiet -r testing/requirements.txt
                    "${PYTHON}" -m pytest testing/ -v --html=reports/test_report.html --self-contained-html
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/*.html', allowEmptyArchive: true
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'reports',
                        reportFiles: 'test_report.html',
                        reportName: 'Test Report'
                    ])
                }
            }
        }
        
        stage('DVC Versioning') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                bat """
                    echo ========================================
                    echo DVC VERSIONING
                    echo ========================================
                    
                    REM Add production data to DVC
                    dvc add data/production/bank_churn_prod.csv
                    
                    REM Commit DVC changes
                    git add data/production/bank_churn_prod.csv.dvc .gitignore
                    git commit -m "dvc: version production data after drift detection" || echo "No DVC changes to commit"
                    
                    REM Push to DVC remote (if configured)
                    dvc push || echo "DVC remote not configured, skipping push"
                    
                    echo DVC versioning complete
                """
            }
        }
    }
    
    post {
        always {
            echo "=========================================="
            echo "Build: ${currentBuild.result ?: 'SUCCESS'}"
            echo "=========================================="
        }
    }
}
