pipeline {
    agent any
    
    environment {
        PYTHONUTF8 = "1"
        PYTHON = "C:\\Users\\Tech House\\AppData\\Local\\Programs\\Python\\Python312\\python.exe"
        DVC = "C:\\Users\\Tech House\\AppData\\Local\\Programs\\Python\\Python312\\Scripts\\dvc.exe"
        MLFLOW_TRACKING_URI = "http://127.0.0.1:5000"
    }
    
    stages {
        stage('Preparation') {
            steps {
                bat """
                    echo ========================================
                    echo PREPARATION - SETUP ET DEPENDENCIES
                    echo ========================================
                    
                    REM Créer les dossiers nécessaires
                    if not exist data mkdir data
                    if not exist data\\production mkdir data\\production
                    if not exist notebooks\\processors mkdir notebooks\\processors
                    if not exist reports mkdir reports
                    
                    REM Copier le dataset source
                    copy "C:\\Users\\Tech House\\Desktop\\3eme\\mlops\\mlops\\MLOps_Bank_Churn\\data\\bank_customer_churn.csv" "data\\bank_customer_churn.csv" /Y
                    
                    REM Copier les processors et données preprocessées
                    copy "C:\\Users\\Tech House\\Desktop\\3eme\\mlops\\mlops\\MLOps_Bank_Churn\\notebooks\\processors\\*.pkl" "notebooks\\processors\\" /Y
                    
                    REM Créer le preprocessor.pkl si nécessaire
                    if not exist "notebooks\\processors\\preprocessor.pkl" (
                        echo Creating preprocessor.pkl...
                        "${PYTHON}" scripts/create_preprocessor.py
                    )
                    
                    REM Générer les batches avec transformations
                    "${PYTHON}" scripts/split_dataset.py
                    
                    echo ========================================
                    echo INSTALLATION DEPENDENCIES
                    echo ========================================
                    "${PYTHON}" -m pip install --quiet numpy==1.26.4 pandas scipy scikit-learn
                    "${PYTHON}" -m pip install --quiet pytest pytest-html deepchecks
                    "${PYTHON}" -m pip install --quiet xgboost lightgbm catboost
                    "${PYTHON}" -m pip install --quiet dvc
                    
                    echo Preparation OK
                """
            }
        }
        
        stage('Simulate New Data') {
            steps {
                bat """
                    echo ========================================
                    echo SIMULATION NOUVELLES DONNEES
                    echo ========================================
                    "${PYTHON}" scripts/generate_prod_data.py batch1
                """
            }
        }
        
        stage('Test: Data Integrity') {
            steps {
                bat """
                    echo ========================================
                    echo TEST: DATA INTEGRITY
                    echo ========================================
                    "${PYTHON}" -m pytest testing/test_data_integrity.py -v --html=reports/data_integrity_report.html --self-contained-html
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/data_integrity_report.html', allowEmptyArchive: true
                }
            }
        }
        
        stage('Preprocessing') {
            steps {
                bat """
                    echo ========================================
                    echo PREPROCESSING PRODUCTION DATA
                    echo ========================================
                    "${PYTHON}" scripts/preprocess_production.py data/production/bank_churn_prod.csv data/production/bank_churn_prod_processed.csv
                """
            }
        }
        
        stage('Test: Preprocessing') {
            steps {
                bat """
                    echo ========================================
                    echo TEST: PREPROCESSING
                    echo ========================================
                    "${PYTHON}" -m pytest testing/test_preprocessing.py -v --html=reports/preprocessing_report.html --self-contained-html
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/preprocessing_report.html', allowEmptyArchive: true
                }
            }
        }
        
        stage('Monitoring & Drift Detection') {
            steps {
                bat """
                    echo ========================================
                    echo MONITORING + DRIFT DETECTION
                    echo ========================================
                    "${PYTHON}" monitoring/run_monitoring.py
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'monitoring/*.html, monitoring/*.json', allowEmptyArchive: true
                }
            }
        }
        
        stage('Test: Data Distribution') {
            steps {
                bat """
                    echo ========================================
                    echo TEST: DATA DISTRIBUTION
                    echo ========================================
                    "${PYTHON}" -m pytest testing/test_data_distribution.py -v --html=reports/distribution_report.html --self-contained-html
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/distribution_report.html', allowEmptyArchive: true
                }
            }
        }
        
    
        
        stage('Training') {
            
            steps {
                bat """
                    echo ========================================
                    echo TRAINING - ENTRAINEMENT DES MODELES
                    echo ========================================
                    "${PYTHON}" scripts/retrain_model.py
                """
            }
        }
        
        stage('Evaluation') {
            steps {
                bat """
                    echo ========================================
                    echo EVALUATION - COMPARAISON DES MODELES
                    echo ========================================
                    "${PYTHON}" -m pytest testing/ -v --html=reports/full_test_report.html --self-contained-html
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/full_test_report.html', allowEmptyArchive: true
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'reports',
                        reportFiles: 'full_test_report.html',
                        reportName: 'Test Report'
                    ])
                }
            }
        }
        
        stage('Deployment') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                bat """
                    echo ========================================
                    echo DEPLOYMENT - DEPLOIEMENT DU MODELE
                    echo ========================================
                    "${PYTHON}" scripts/deploy_local.py
                """
            }
            post {
                success {
                    echo '✅ Model deployed successfully'
                }
                failure {
                    echo '❌ Deployment failed'
                }
            }
        }
        
        stage('DVC Versioning') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                bat """
                    echo ========================================
                    echo DVC VERSIONING
                    echo ========================================
                    
                    REM Configure Git Identity for Jenkins
                    git config user.email "jenkins@mlops.local"
                    git config user.name "Jenkins Pipeline"
                    
                    REM Update PATH to include Python Scripts (where dvc.exe is)
                    set PATH=%PATH%;C:\\Users\\Tech House\\AppData\\Local\\Programs\\Python\\Python312\\Scripts
                    
                    REM Run DVC Setup Script in CI mode
                    call dvc_setup.bat --no-pause
                """
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline completed'
        }
        success {
            echo '✅ Build successful'
        }
        failure {
            echo '❌ Build failed'
        }
    }
}
