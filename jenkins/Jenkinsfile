// Jenkinsfile pour le pipeline MLOps
// Pipeline CI/CD avec monitoring, data drift detection et DVC versioning

pipeline {
    agent any
    
    // Variables d'environnement
    environment {
        PROJECT_DIR = "${WORKSPACE}"
        PYTHON_ENV = "c:/Users/Tech House/AppData/Local/Programs/Python/Python312/python.exe"
        DRIFT_THRESHOLD = "0.1"
        PYTHONUTF8 = "1" // Force UTF-8 encoding for Python
    }
    
    // D√©clenchement automatique
    triggers {
        // Ex√©cution quotidienne √† 2h du matin
        cron('0 2 * * *')
    }
    
    stages {
        // ====================================================================
        // STAGE 0: SETUP - Installation et pr√©paration
        // ====================================================================
        stage('Setup Environment') {
            steps {
                echo 'üîß Installation des d√©pendances...'
                
                script {
                    try {
                        // Nettoyer l'ancien venv pour garantir une install propre
                        bat """
                            if exist venv rmdir /s /q venv
                        """

                        // Cr√©er un environnement virtuel
                        bat """
                            echo "Cr√©ation du venv..."
                            "${PYTHON_ENV}" -m venv venv
                        """

                        // Workaround: Copier les donn√©es depuis le dossier local car non pr√©sentes dans Git
                        // Jenkins ne trouve pas les fichiers ignor√©s par .gitignore
                        bat """
                            if not exist data mkdir data
                            copy "C:\\Users\\Tech House\\Desktop\\3eme\\mlops\\mlops\\MLOps_Bank_Churn\\data\\churn.csv" "data\\churn.csv"
                        """

                        // Installer les d√©pendances
                        bat """
                            venv\\Scripts\\python.exe -m pip install --upgrade pip setuptools wheel
                            venv\\Scripts\\python.exe -m pip install -r monitoring/requirements.txt
                            echo "--- PIP LIST (Diagnostic) ---"
                            venv\\Scripts\\python.exe -m pip list
                        """
                        echo '‚úÖ D√©pendances v√©rifi√©es'
                        
                        // Diagnostic import
                        bat """
                            echo "--- IMPORT TEST (Diagnostic) ---"
                            venv\\Scripts\\python.exe -c "import sys; print(f'Python: {sys.executable}'); print(sys.path); import evidently; print(f'Evidently version: {evidently.__version__}')"
                        """

                        // G√©n√©rer les donn√©es de production
                        bat """
                            venv\\Scripts\\python.exe scripts/generate_prod_data.py
                        """
                        echo '‚úÖ Donn√©es de production g√©n√©r√©es'
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è  Erreur setup: ${e.message}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
        
        // ====================================================================
        // STAGE 1: MONITORING - Ex√©cution du script de monitoring
        // ====================================================================
        stage('Data Drift Monitoring') {
            steps {
                echo 'üîç Ex√©cution du monitoring Evidently...'
                
                script {
                    try {
                        // Ex√©cuter le script de monitoring
                        bat """
                            venv\\Scripts\\python.exe monitoring/run_monitoring.py
                        """
                        echo '‚úÖ Monitoring termin√© avec succ√®s'
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è  Erreur lors du monitoring: ${e.message}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
            
            post {
                always {
                    // Archiver les rapports g√©n√©r√©s
                    archiveArtifacts artifacts: 'monitoring/*.html, monitoring/*.json', 
                                   allowEmptyArchive: true
                    
                    // Publier le rapport HTML
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'monitoring',
                        reportFiles: 'monitoring_report.html',
                        reportName: 'Evidently Data Drift Report'
                    ])
                }
            }
        }
        
        // ====================================================================
        // STAGE 2: CHECK DRIFT - V√©rifier si un drift a √©t√© d√©tect√©
        // ====================================================================
        stage('Check Data Drift') {
            steps {
                echo 'üìä V√©rification du data drift...'
                
                script {
                    // V√©rifier l'existence du fichier trigger
                    def triggerExists = fileExists('trigger.txt')
                    
                    if (triggerExists) {
                        echo 'üö® DATA DRIFT DETECTED!'
                        
                        // Lire le contenu du trigger
                        def triggerContent = readFile('trigger.txt')
                        echo "D√©tails du drift:\n${triggerContent}"
                        
                        // Marquer le build comme instable
                        currentBuild.result = 'UNSTABLE'
                        
                        // D√©finir une variable pour les stages suivants
                        env.DRIFT_DETECTED = 'true'
                    } else {
                        echo '‚úÖ Aucun drift d√©tect√© - Mod√®le stable'
                        env.DRIFT_DETECTED = 'false'
                    }
                }
            }
        }
        
        // ====================================================================
        // STAGE 3: DVC VERSIONING - Versionner si drift d√©tect√©
        // ====================================================================
        stage('DVC Versioning') {
            when {
                expression { env.DRIFT_DETECTED == 'true' }
            }
            
            steps {
                echo 'üì¶ Versioning avec DVC...'
                
                script {
                    try {
                        // Initialiser DVC si n√©cessaire
                        bat """
                            dvc init --force || echo "DVC d√©j√† initialis√©"
                        """
                        
                        // Ajouter les donn√©es de production
                        bat """
                            dvc add data/production/bank_churn_prod.csv
                        """
                        
                        // Commit DVC
                        bat """
                            git add data/production/bank_churn_prod.csv.dvc .dvc/config
                            git commit -m "DVC: Version production data after drift detection" || echo "Rien √† commiter"
                        """
                        
                        // Push DVC (vers remote local)
                        bat """
                            dvc push || echo "DVC push √©chou√© - v√©rifier la configuration du remote"
                        """
                        
                        echo '‚úÖ Versioning DVC termin√©'
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è  Erreur DVC: ${e.message}"
                        echo "Note: DVC n√©cessite une configuration pr√©alable"
                    }
                }
            }
        }
        
        // ====================================================================
        // STAGE 4: NOTIFICATION - Envoyer des alertes
        // ====================================================================
        stage('Notification') {
            steps {
                echo 'üìß Envoi des notifications...'
                
                script {
                    if (env.DRIFT_DETECTED == 'true') {
                        // Notification de drift d√©tect√©
                        echo """
                        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
                        ‚ïë   üö® DATA DRIFT ALERT üö®              ‚ïë
                        ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
                        ‚ïë Un drift significatif a √©t√© d√©tect√©   ‚ïë
                        ‚ïë dans les donn√©es de production.       ‚ïë
                        ‚ïë                                        ‚ïë
                        ‚ïë Actions recommand√©es:                  ‚ïë
                        ‚ïë 1. Consulter le rapport Evidently     ‚ïë
                        ‚ïë 2. Analyser les colonnes avec drift   ‚ïë
                        ‚ïë 3. Consid√©rer le r√©entra√Ænement       ‚ïë
                        ‚ïë 4. V√©rifier le versioning DVC         ‚ïë
                        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                        """
                        
                        // Dans un environnement r√©el, envoyer un email/Slack
                        // emailext subject: "Data Drift Detected",
                        //          body: readFile('trigger.txt'),
                        //          to: "data-team@company.com"
                    } else {
                        echo '‚úÖ Syst√®me stable - Aucune action requise'
                    }
                }
            }
        }
    }
    
    // ====================================================================
    // POST-BUILD ACTIONS
    // ====================================================================
    post {
        success {
            echo '‚úÖ Pipeline termin√© avec succ√®s'
        }
        
        unstable {
            echo '‚ö†Ô∏è  Pipeline termin√© avec warnings (drift d√©tect√©)'
        }
        
        failure {
            echo '‚ùå Pipeline √©chou√©'
        }
        
        always {
            // Nettoyer les fichiers temporaires
            echo 'üßπ Nettoyage...'
            
            // Archiver les logs
            archiveArtifacts artifacts: 'trigger.txt', 
                           allowEmptyArchive: true
        }
    }
}
