// Jenkinsfile MLOps - Version finale fonctionnelle
pipeline {
    agent any
    
    environment {
        PYTHON = "C:\\Users\\Tech House\\AppData\\Local\\Programs\\Python\\Python312\\python.exe"
        PYTHONUTF8 = "1"
    }
    
    stages {
        stage('Setup') {
            steps {
                bat """
                    echo ========================================
                    echo SETUP
                    echo ========================================
                    if not exist data mkdir data
                    if not exist data\\production mkdir data\\production
                    echo Setup OK
                """
            }
        }
        
        stage('Install') {
            steps {
                bat """
                    echo ========================================
                    echo INSTALLATION
                    echo ========================================
                    "${PYTHON}" -m pip install --quiet evidently==0.4.33 pandas numpy
                    "${PYTHON}" -c "from evidently.report import Report; print('âœ“ Evidently OK')"
                """
            }
        }
        
        stage('Generate Data') {
            steps {
                bat """
                    echo ========================================
                    echo GENERATION DONNEES
                    echo ========================================
                    "${PYTHON}" scripts/generate_prod_data.py
                """
            }
        }
        
        stage('Monitor') {
            steps {
                bat """
                    echo ========================================
                    echo MONITORING
                    echo ========================================
                    "${PYTHON}" monitoring/run_monitoring.py
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'monitoring/*.html, monitoring/*.json', allowEmptyArchive: true
                }
            }
        }
        
        stage('Check Drift') {
            steps {
                script {
                    if (fileExists('trigger.txt')) {
                        echo 'ðŸš¨ DRIFT DETECTED'
                        currentBuild.result = 'UNSTABLE'
                    } else {
                        echo 'âœ“ No drift'
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "=========================================="
            echo "Build: ${currentBuild.result ?: 'SUCCESS'}"
            echo "=========================================="
        }
    }
}
