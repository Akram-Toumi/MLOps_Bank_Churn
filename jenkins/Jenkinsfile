// Jenkinsfile MLOps - Version ultra-simplifiÃ©e
pipeline {
    agent any
    
    environment {
        PYTHONUTF8 = "1"
    }
    
    stages {
        stage('Setup') {
            steps {
                bat """
                    echo ========================================
                    echo SETUP
                    echo ========================================
                    
                    REM CrÃ©er dossier data si nÃ©cessaire
                    if not exist data mkdir data
                    if not exist data\\production mkdir data\\production
                    
                    REM Copier churn.csv depuis le workspace local (pas depuis Desktop)
                    REM Le fichier devrait Ãªtre dans le repo Git
                    if exist ..\\..\\..\\..\\data\\churn.csv (
                        copy ..\\..\\..\\..\\data\\churn.csv data\\churn.csv /Y
                    ) else (
                        echo WARNING: churn.csv not found, using existing if available
                    )
                    
                    echo Setup OK
                """
            }
        }
        
        stage('Install Dependencies') {
            steps {
                bat """
                    echo ========================================
                    echo INSTALLATION
                    echo ========================================
                    
                    REM Utiliser Python systÃ¨me
                    python -m pip install --quiet evidently==0.4.33 pandas numpy
                    
                    REM VÃ©rifier
                    python -c "from evidently.report import Report; print('OK')"
                    
                    echo Installation OK
                """
            }
        }
        
        stage('Generate Data') {
            steps {
                bat """
                    echo ========================================
                    echo GENERATION DONNEES
                    echo ========================================
                    python scripts/generate_prod_data.py
                """
            }
        }
        
        stage('Monitor') {
            steps {
                bat """
                    echo ========================================
                    echo MONITORING
                    echo ========================================
                    python monitoring/run_monitoring.py
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'monitoring/*.html, monitoring/*.json', allowEmptyArchive: true
                }
            }
        }
        
        stage('Check Drift') {
            steps {
                script {
                    if (fileExists('trigger.txt')) {
                        echo 'ðŸš¨ DRIFT DETECTED'
                        currentBuild.result = 'UNSTABLE'
                    } else {
                        echo 'âœ“ No drift'
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "Build: ${currentBuild.result ?: 'SUCCESS'}"
        }
    }
}
