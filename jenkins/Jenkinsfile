// Jenkinsfile pour le pipeline MLOps
// Pipeline CI/CD avec monitoring, data drift detection et DVC versioning

pipeline {
    agent any
    
    // Variables d'environnement
    environment {
        PROJECT_DIR = "${WORKSPACE}"
        PYTHON_ENV = "${PROJECT_DIR}/.venv/Scripts/python.exe"
        DRIFT_THRESHOLD = "0.1"
    }
    
    // DÃ©clenchement automatique
    triggers {
        // ExÃ©cution quotidienne Ã  2h du matin
        cron('0 2 * * *')
    }
    
    stages {
        // ====================================================================
        // STAGE 1: MONITORING - ExÃ©cution du script de monitoring
        // ====================================================================
        stage('Data Drift Monitoring') {
            steps {
                echo 'ğŸ” ExÃ©cution du monitoring Evidently...'
                
                script {
                    try {
                        // ExÃ©cuter le script de monitoring
                        bat """
                            ${PYTHON_ENV} monitoring/run_monitoring.py
                        """
                        echo 'âœ… Monitoring terminÃ© avec succÃ¨s'
                    } catch (Exception e) {
                        echo "âš ï¸  Erreur lors du monitoring: ${e.message}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
            
            post {
                always {
                    // Archiver les rapports gÃ©nÃ©rÃ©s
                    archiveArtifacts artifacts: 'monitoring/*.html, monitoring/*.json', 
                                   allowEmptyArchive: true
                    
                    // Publier le rapport HTML
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'monitoring',
                        reportFiles: 'monitoring_report.html',
                        reportName: 'Evidently Data Drift Report'
                    ])
                }
            }
        }
        
        // ====================================================================
        // STAGE 2: CHECK DRIFT - VÃ©rifier si un drift a Ã©tÃ© dÃ©tectÃ©
        // ====================================================================
        stage('Check Data Drift') {
            steps {
                echo 'ğŸ“Š VÃ©rification du data drift...'
                
                script {
                    // VÃ©rifier l'existence du fichier trigger
                    def triggerExists = fileExists('trigger.txt')
                    
                    if (triggerExists) {
                        echo 'ğŸš¨ DATA DRIFT DETECTED!'
                        
                        // Lire le contenu du trigger
                        def triggerContent = readFile('trigger.txt')
                        echo "DÃ©tails du drift:\n${triggerContent}"
                        
                        // Marquer le build comme instable
                        currentBuild.result = 'UNSTABLE'
                        
                        // DÃ©finir une variable pour les stages suivants
                        env.DRIFT_DETECTED = 'true'
                    } else {
                        echo 'âœ… Aucun drift dÃ©tectÃ© - ModÃ¨le stable'
                        env.DRIFT_DETECTED = 'false'
                    }
                }
            }
        }
        
        // ====================================================================
        // STAGE 3: DVC VERSIONING - Versionner si drift dÃ©tectÃ©
        // ====================================================================
        stage('DVC Versioning') {
            when {
                expression { env.DRIFT_DETECTED == 'true' }
            }
            
            steps {
                echo 'ğŸ“¦ Versioning avec DVC...'
                
                script {
                    try {
                        // Initialiser DVC si nÃ©cessaire
                        bat """
                            dvc init --force || echo "DVC dÃ©jÃ  initialisÃ©"
                        """
                        
                        // Ajouter les donnÃ©es de production
                        bat """
                            dvc add data/production/bank_churn_prod.csv
                        """
                        
                        // Commit DVC
                        bat """
                            git add data/production/bank_churn_prod.csv.dvc .dvc/config
                            git commit -m "DVC: Version production data after drift detection" || echo "Rien Ã  commiter"
                        """
                        
                        // Push DVC (vers remote local)
                        bat """
                            dvc push || echo "DVC push Ã©chouÃ© - vÃ©rifier la configuration du remote"
                        """
                        
                        echo 'âœ… Versioning DVC terminÃ©'
                    } catch (Exception e) {
                        echo "âš ï¸  Erreur DVC: ${e.message}"
                        echo "Note: DVC nÃ©cessite une configuration prÃ©alable"
                    }
                }
            }
        }
        
        // ====================================================================
        // STAGE 4: NOTIFICATION - Envoyer des alertes
        // ====================================================================
        stage('Notification') {
            steps {
                echo 'ğŸ“§ Envoi des notifications...'
                
                script {
                    if (env.DRIFT_DETECTED == 'true') {
                        // Notification de drift dÃ©tectÃ©
                        echo """
                        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                        â•‘   ğŸš¨ DATA DRIFT ALERT ğŸš¨              â•‘
                        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
                        â•‘ Un drift significatif a Ã©tÃ© dÃ©tectÃ©   â•‘
                        â•‘ dans les donnÃ©es de production.       â•‘
                        â•‘                                        â•‘
                        â•‘ Actions recommandÃ©es:                  â•‘
                        â•‘ 1. Consulter le rapport Evidently     â•‘
                        â•‘ 2. Analyser les colonnes avec drift   â•‘
                        â•‘ 3. ConsidÃ©rer le rÃ©entraÃ®nement       â•‘
                        â•‘ 4. VÃ©rifier le versioning DVC         â•‘
                        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        """
                        
                        // Dans un environnement rÃ©el, envoyer un email/Slack
                        // emailext subject: "Data Drift Detected",
                        //          body: readFile('trigger.txt'),
                        //          to: "data-team@company.com"
                    } else {
                        echo 'âœ… SystÃ¨me stable - Aucune action requise'
                    }
                }
            }
        }
    }
    
    // ====================================================================
    // POST-BUILD ACTIONS
    // ====================================================================
    post {
        success {
            echo 'âœ… Pipeline terminÃ© avec succÃ¨s'
        }
        
        unstable {
            echo 'âš ï¸  Pipeline terminÃ© avec warnings (drift dÃ©tectÃ©)'
        }
        
        failure {
            echo 'âŒ Pipeline Ã©chouÃ©'
        }
        
        always {
            // Nettoyer les fichiers temporaires
            echo 'ğŸ§¹ Nettoyage...'
            
            // Archiver les logs
            archiveArtifacts artifacts: 'trigger.txt', 
                           allowEmptyArchive: true
        }
    }
}
