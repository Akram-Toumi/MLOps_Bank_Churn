// Jenkinsfile pour le pipeline MLOps - Version simplifiÃ©e et fonctionnelle
pipeline {
    agent any
    
    environment {
        PYTHON_PATH = "C:/Users/Tech House/AppData/Local/Programs/Python/Python312/python.exe"
        PYTHONUTF8 = "1"
        DATA_SOURCE = "C:/Users/Tech House/Desktop/3eme/mlops/mlops/MLOps_Bank_Churn/data/churn.csv"
    }
    
    stages {
        stage('Setup') {
            steps {
                script {
                    bat """
                        @echo off
                        echo ========================================
                        echo SETUP ENVIRONMENT
                        echo ========================================
                        
                        REM Nettoyer ancien venv
                        if exist venv rmdir /s /q venv
                        
                        REM CrÃ©er nouveau venv
                        "${PYTHON_PATH}" -m venv venv
                        
                        REM Copier donnÃ©es
                        if not exist data mkdir data
                        copy "${DATA_SOURCE}" "data\\churn.csv" /Y
                        
                        REM Installer dÃ©pendances
                        venv\\Scripts\\python.exe -m pip install --quiet --upgrade pip
                        venv\\Scripts\\python.exe -m pip install --quiet --no-cache-dir evidently==0.4.33 pandas==2.0.3 numpy==1.24.3
                        
                        REM VÃ©rifier installation
                        venv\\Scripts\\python.exe -c "import evidently; from evidently.report import Report; print('âœ“ Evidently OK')" || exit /b 1
                        
                        echo âœ“ Setup terminÃ©
                    """
                }
            }
        }
        
        stage('Generate Production Data') {
            steps {
                script {
                    bat """
                        @echo off
                        echo ========================================
                        echo GENERATION DONNEES PRODUCTION
                        echo ========================================
                        venv\\Scripts\\python.exe scripts/generate_prod_data.py
                    """
                }
            }
        }
        
        stage('Run Monitoring') {
            steps {
                script {
                    bat """
                        @echo off
                        echo ========================================
                        echo MONITORING DATA DRIFT
                        echo ========================================
                        venv\\Scripts\\python.exe monitoring/run_monitoring.py
                    """
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'monitoring/*.html, monitoring/*.json', allowEmptyArchive: true
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'monitoring',
                        reportFiles: 'monitoring_report.html',
                        reportName: 'Evidently Report'
                    ])
                }
            }
        }
        
        stage('Check Drift') {
            steps {
                script {
                    def driftDetected = fileExists('trigger.txt')
                    if (driftDetected) {
                        echo 'ðŸš¨ DATA DRIFT DETECTED'
                        currentBuild.result = 'UNSTABLE'
                    } else {
                        echo 'âœ“ No drift detected'
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo '=========================================='
            echo "Build: ${currentBuild.result ?: 'SUCCESS'}"
            echo '=========================================='
        }
    }
}
